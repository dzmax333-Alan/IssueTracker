<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å·¥å» ç•°å¸¸è¿½è¹¤ç³»çµ± (é›²ç«¯ç©©å®šç‰ˆ v6.3)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --warning: #ca8a04; --danger: #dc2626; --gray: #64748b; --excel: #1d6f42; --mail: #0ea5e9; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: #f8fafc; margin: 10px; color: #1e293b; }
        .container { max-width: 100%; margin: auto; background: white; padding: 12px 15px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .header-section { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e2e8f0; margin-bottom: 15px; padding-bottom: 12px; gap: 20px; flex-wrap: wrap; }
        .title-group { display: flex; align-items: center; white-space: nowrap; flex-shrink: 0; gap: 10px; }
        .search-group { display: flex; align-items: center; gap: 8px; background: #f1f5f9; padding: 5px 10px; border-radius: 8px; }
        .action-group { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        
        /* è¡¨æ ¼æ¨£å¼å„ªåŒ– */
        .issue-table { width: 100%; border-collapse: separate; border-spacing: 0; table-layout: fixed; font-size: 13px; }
        .issue-table th { background-color: #f1f5f9; padding: 10px 4px; text-align: left; border-bottom: 2px solid #e2e8f0; font-weight: 600; color: #475569; position: sticky; top: 0; z-index: 10; }
        .issue-table td { border-bottom: 1px solid #e2e8f0; padding: 6px 4px; vertical-align: middle; position: relative; }
        
        .badge { font-size: 11px; padding: 2px 4px; border-radius: 4px; font-weight: bold; display: block; margin-top: 4px; text-align: center; border: 1px solid rgba(0,0,0,0.1); }
        .badge-new { background-color: #fef9c3; color: #854d0e; }
        .badge-tracking { background-color: #e0f2fe; color: #0369a1; }
        .badge-closed { background-color: #f0fdf4; color: #166534; }
        .badge-cloud { background-color: #f3e8ff; color: #6b21a8; border: 1px solid #d8b4fe; display: inline-flex; align-items: center; gap: 4px; padding: 2px 6px; border-radius: 4px; font-size: 11px; }

        input, textarea, select { width: 100%; border: 1px solid #cbd5e1; padding: 4px 6px; border-radius: 6px; font-size: 13px; box-sizing: border-box; transition: border-color 0.2s; }
        input:focus, textarea:focus, select:focus { border-color: var(--primary); outline: none; }
        
        .btn { padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 13px; display: inline-flex; align-items: center; gap: 6px; color: white; justify-content: center; transition: opacity 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .btn svg { width: 16px; height: 16px; stroke-width: 2.5; } 
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        
        .btn-primary { background-color: var(--primary); }
        .btn-save { background-color: var(--success); }
        .btn-close { background-color: var(--gray); }
        .btn-del { background-color: var(--danger); }
        .btn-excel { background-color: var(--excel); }
        .btn-edit { background-color: #6366f1; }
        .btn-mail { background-color: var(--mail); }
        .btn-refresh { background-color: #0d9488; }
        .btn-upload { background-color: #d97706; }
        
        .btn-op { width: 100%; margin-bottom: 4px; padding: 4px 0; font-size: 12px; gap: 4px; }
        .btn-op svg { width: 14px; height: 14px; }
        
        .zoom-icon { position: absolute; top: 8px; right: 8px; cursor: pointer; background: rgba(255,255,255,0.9); border-radius: 4px; padding: 4px; z-index: 5; color: var(--primary); border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; width: 20px; height: 20px; }
        .zoom-icon svg { width: 14px; height: 14px; }

        .thumb-container { display: flex; flex-wrap: wrap; gap: 4px; min-height: 35px; margin-bottom: 4px; }
        .img-wrapper { position: relative; width: 35px; height: 35px; border: 1px solid #ddd; border-radius: 4px; background: #fff; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .img-thumb { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }
        
        .file-icon-svg { width: 20px; height: 20px; color: #555; }
        .file-icon-link { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: inherit; width: 100%; height: 100%; justify-content: center; }
        
        .img-del { position: absolute; top: 0; right: 0; background: red; color: white; width: 12px; height: 12px; font-size: 10px; text-align: center; cursor: pointer; opacity: 0.8; line-height: 12px; z-index: 10; display: flex; align-items: center; justify-content: center; }
        
        #lightbox { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); justify-content: center; align-items: center; }
        #lightbox img { max-width: 95%; max-height: 95%; border: 3px solid white; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow-y: auto; justify-content: center; align-items: flex-start; padding-top: 50px; }
        .modal-content { background: white; padding: 25px; width: 700px; max-width: 90%; border-radius: 12px; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-close { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #64748b; }
        
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 12px; position: fixed; z-index: 2000; right: 30px; bottom: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; gap: 8px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        #toast.loading { background-color: var(--primary); visibility: visible; animation: none; }
        
        .loader { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid white; width: 16px; height: 16px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .content-box { font-size: 16px; line-height: 1.6; white-space: pre-wrap; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 15px; }
        .img-gallery { display: flex; flex-wrap: wrap; gap: 10px; }
        .large-thumb-box { width: 120px; height: 120px; border: 1px solid #ccc; border-radius: 8px; position: relative; display: flex; align-items: center; justify-content: center; background: #fff; overflow: hidden; }
        .large-thumb-img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }
        
        /* éŒ¯èª¤åœ–ç‰‡æ¨£å¼ */
        .broken-img-box { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fee2e2; color: #dc2626; font-size: 9px; text-align: center; }
    </style>
</head>
<body>

<div id="toast"><div class="loader" id="toast-loader"></div><span id="toast-msg">æ“ä½œæˆåŠŸ</span></div>
<div id="lightbox" onclick="this.style.display='none'"><img id="lightbox-img" src=""></div>
<input type="file" id="batchUploadFile" style="display:none" accept=".json" onchange="handleBatchUpload(this)">

<!-- è¨­å®šè¦–çª— -->
<div id="settingModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeSettingModal()">Ã—</span>
        <h3><span class="icon-svg"><!-- Icon by JS --></span> å€‹äººåŒ–é¡¯ç¤ºè¨­å®š</h3>
        <p style="color: #64748b; font-size: 12px;">é€™äº›è¨­å®šåªæœƒå„²å­˜åœ¨é€™å°é›»è…¦ä¸Šï¼Œä¸å½±éŸ¿é›²ç«¯è³‡æ–™ã€‚</p>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top: 15px;">
            <div style="border:1px solid #eee; padding:10px; border-radius: 8px;">
                <h4>è² è²¬äºº / ç•°å¸¸é¡åˆ¥</h4>
                <div style="display:flex; gap:5px; margin-bottom:5px">
                    <input type="text" id="newPeName" placeholder="å§“å">
                    <button class="btn btn-primary" style="padding: 2px 8px;" onclick="addSettingItem('pe')">ï¼‹</button>
                </div>
                <ul id="peListContainer" style="height:100px; overflow-y:auto; font-size:12px; border:1px solid #ddd; padding:5px; list-style:none; margin:0;"></ul>
                <div style="display:flex; gap:5px; margin-top:10px; margin-bottom: 5px;">
                    <input type="text" id="newCatName" placeholder="é¡åˆ¥">
                    <button class="btn btn-primary" style="padding: 2px 8px;" onclick="addSettingItem('cat')">ï¼‹</button>
                </div>
                <ul id="catListContainer" style="height:100px; overflow-y:auto; font-size:12px; border:1px solid #ddd; padding:5px; list-style:none; margin:0;"></ul>
            </div>
            <div style="border:1px solid #eee; padding:10px; border-radius: 8px;">
                <h4>è¶…æ™‚è­¦ç¤ºé¡è‰²</h4>
                <div id="colorSettingsList"></div>
                <button class="btn btn-primary" style="margin-top:10px" onclick="addColorSetting()">ï¼‹ æ–°å¢è¦å‰‡</button>
            </div>
        </div>
        <button class="btn btn-save" style="margin-top:20px; width:100%; height:40px" onclick="closeSettingModal()">å„²å­˜è¨­å®š</button>
    </div>
</div>

<!-- åŒ¯å‡ºè¦–çª— -->
<div id="exportModal" class="modal">
    <div class="modal-content" style="width:350px">
        <h3>ğŸ“Š åŒ¯å‡º Excel å ±è¡¨</h3>
        <p>é¸æ“‡åŒ¯å‡ºç‹€æ…‹ï¼š</p>
        <select id="exportStatusSelect" style="margin-bottom:20px">
            <option value="all">å…¨éƒ¨</option>
            <option value="active">å¾…è™•ç†</option>
            <option value="closed">å·²çµæ¡ˆ</option>
        </select>
        <div style="display:flex; gap:10px">
            <button class="btn btn-save" style="flex:1" onclick="executeExport()">ä¸‹è¼‰ Excel</button>
            <button class="btn" style="background:#94a3b8; flex:1" onclick="document.getElementById('exportModal').style.display='none'">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- è©³ç´°å…§å®¹è¦–çª— -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeDetailModal()">Ã—</span>
        <h3 id="detailTitle">å…§å®¹è©³æƒ…</h3>
        <div id="detailText" class="content-box"></div>
        <h4>é™„ä»¶æ¸…å–®</h4>
        <div id="detailImgs" class="img-gallery"></div>
    </div>
</div>

<!-- ä¸»ä»‹é¢ -->
<div class="container">
    <div class="header-section">
        <div class="title-group">
            <h2 style="margin:0; display:flex; align-items:center; gap:8px;">
                <!-- é›²ç«¯ Icon -->
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#2563eb"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>
                å·¥å» ç•°å¸¸è¿½è¹¤ <span class="badge-cloud">é›²ç«¯ç‰ˆ v6.3</span>
            </h2>
            <div class="search-group">
                <!-- æ–°å¢ï¼šè² è²¬äººç¯©é¸ -->
                <select id="peFilter" onchange="renderTable()" style="width: 100px; font-weight:bold; color:#2563eb;"><option value="all">è² è²¬äºº(å…¨)</option></select>
                <select id="searchField" style="width: 70px;"><option value="workOrder">å·¥å–®</option><option value="model">æ©Ÿç¨®</option></select>
                <input type="text" id="searchInput" placeholder="é—œéµå­—..." oninput="renderTable()" style="width: 100px;">
                <select id="categoryFilter" onchange="renderTable()" style="width: 100px;"><option value="all">é¡åˆ¥(å…¨)</option></select>
            </div>
        </div>
        <div class="action-group">
            <select id="statusFilter" onchange="renderTable()" style="width:auto;">
                <option value="all">ğŸ” å…¨éƒ¨</option>
                <option value="active">âš¡ å¾…è™•ç†</option>
                <option value="closed">âœ… å·²çµæ¡ˆ</option>
            </select>
            <button class="btn btn-refresh" onclick="confirmReload()" title="å¾ Google Sheet ä¸‹è¼‰æœ€æ–°è³‡æ–™">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                è®€å–é›²ç«¯
            </button>
            <button class="btn btn-primary" onclick="addNewRow()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                æ–°å¢
            </button>
            <button class="btn btn-excel" onclick="openExportModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                åŒ¯å‡º
            </button>
            <button class="btn btn-mail" onclick="sendMail()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                Mail
            </button>
            <button class="btn btn-upload" onclick="document.getElementById('batchUploadFile').click()" title="åŒ¯å…¥èˆŠç‰ˆè³‡æ–™">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                åŒ¯å…¥
            </button>
            <button class="btn" style="background:#64748b;" onclick="openSettingModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                è¨­å®š
            </button>
        </div>
    </div>
    
    <div style="overflow-x: auto;">
        <table class="issue-table" id="issueTable">
            <thead>
                <tr>
                    <th style="width:30px; text-align:center"><input type="checkbox" onclick="toggleSelectAll(this)"></th>
                    <th style="width:80px">ID/ç‹€æ…‹</th> <!-- IDæ¬„ä½åŠ å¯¬ -->
                    <th style="width:105px">ç™¼ç”Ÿæ—¥æœŸ</th>
                    <th style="width:120px">å·¥å–®/æ©Ÿç¨®</th>
                    <th style="width:110px">æ‰¹é‡/ä¸è‰¯/ç‡</th>
                    <th style="width:85px">ç™¼ç”Ÿåœ–/æ–‡</th>
                    <th>å•é¡Œæè¿°</th>
                    <th style="width:85px">è² è²¬äºº</th>
                    <th>æ”¹å–„å›è¦†</th>
                    <th style="width:85px">æˆæœåœ–/æ–‡</th>
                    <th style="width:105px">å®Œæˆæ—¥æœŸ</th>
                    <th style="width:100px">æ“ä½œå‹•ä½œ</th>
                </tr>
            </thead>
            <tbody>
                <!-- è³‡æ–™å°‡ç”± JS æ¸²æŸ“ -->
            </tbody>
        </table>
    </div>
    <div id="empty-msg" style="text-align:center; padding: 20px; color: #94a3b8; display: none;">ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œè«‹é»æ“Šã€Œè®€å–é›²ç«¯ã€æˆ–ã€Œæ–°å¢ã€ã€‚</div>
</div>

<script>
    // ==========================================
    // âš ï¸ è«‹åœ¨æ­¤è™•å¡«å…¥ä½ çš„ Google Sheet ç›¸é—œç¶²å€ âš ï¸
    // ==========================================
    
    // 1. Google Apps Script ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ (ç”¨æ–¼å¯«å…¥/åˆªé™¤)
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyRxyG6N8m_1Zo0g3t2C4TtYfaAqUZ0S2wDW8mSLvQd4aRNFsDIw72HpbP2NL003SDaDg/exec";
    
    // 2. Google Sheet ç™¼å¸ƒçš„ CSV é€£çµ (ç”¨æ–¼è®€å–)
    // å–å¾—æ–¹å¼ï¼šæª”æ¡ˆ -> åˆ†äº« -> ç™¼å¸ƒåˆ°ç¶²è·¯ -> é¸æ“‡ CSV -> è¤‡è£½é€£çµ
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTVqkd29Qc27N_EtU00ETP0o1p7oZVCRk-EGu8sWIvrmzoSX7qLVTIT3Namhn4tyD02ij8wlupLv3Zm/pub?output=csv";

    // ==========================================

    // SVG åœ–ç¤ºå®šç¾© (é›†ä¸­ç®¡ç†)
    const ICONS = {
        zoom: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>`,
        save: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>`,
        close: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
        edit: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`,
        trash: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`,
        filePdf: `<svg class="file-icon-svg" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M9 15h6"></path><path d="M9 12h6"></path><path d="M9 18h6"></path></svg>`,
        fileDoc: `<svg class="file-icon-svg" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`,
        fileXls: `<svg class="file-icon-svg" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M8 13h8"></path><path d="M8 17h8"></path><path d="M10 9v8"></path></svg>`,
        fileGen: `<svg class="file-icon-svg" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>`,
        broken: `<svg viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2"><line x1="2" y1="2" x2="22" y2="22"></line><circle cx="12" cy="12" r="10"></circle></svg>`
    };

    let issuesData = {}; 
    let peList = []; 
    let catList = []; 
    let colorSettings = [];

    window.onload = async () => {
        loadSettings();
        if(GOOGLE_SCRIPT_URL.includes("è«‹åœ¨æ­¤å¡«å…¥") || SHEET_CSV_URL.includes("è«‹åœ¨æ­¤å¡«å…¥")) {
            alert("âš ï¸ è¨­å®šæœªå®Œæˆï¼\nè«‹ç·¨è¼¯ HTML æª”æ¡ˆï¼Œå¡«å…¥æ‚¨è‡ªå·±çš„ Google Script èˆ‡ CSV ç¶²å€ã€‚");
        } else {
            await loadAllData();
        }
    };

    async function confirmReload() {
        if(confirm("ç¢ºå®šè¦å¾é›²ç«¯é‡æ–°è®€å–è³‡æ–™å—ï¼Ÿ\nâš ï¸ å°šæœªæŒ‰ã€Œå„²å­˜ã€çš„ä¿®æ”¹å°‡æœƒéºå¤±ã€‚\nâš ï¸ é›²ç«¯ CSV æœ‰ 3~5 åˆ†é˜å»¶é²ï¼Œå¦‚æœä½ å‰›æŒ‰å„²å­˜ï¼Œè«‹ç¨ç­‰å†è®€å–ã€‚")) {
            await loadAllData();
        }
    }

    async function loadAllData() {
        showLoading("ğŸ“¥ æ­£åœ¨ä¸‹è¼‰é›²ç«¯è³‡æ–™...");
        try {
            const res = await fetch(SHEET_CSV_URL + "&t=" + Date.now());
            const contentType = res.headers.get("content-type");
            if (contentType && contentType.includes("text/html")) {
                throw new Error("æ¬Šé™éŒ¯èª¤ï¼šç„¡æ³•è®€å– CSVã€‚\nè«‹æª¢æŸ¥ Google Sheetã€Œç™¼å¸ƒåˆ°ç¶²è·¯ã€æ˜¯å¦è¨­ç‚ºã€Œå…¬é–‹ã€ã€‚");
            }
            if (!res.ok) throw new Error("ç¶²è·¯è«‹æ±‚å¤±æ•—");
            const text = await res.text();
            
            issuesData = csvToJSON(text);
            updateFilters(); // æ›´æ–°æ‰€æœ‰ç¯©é¸é¸å–®
            renderTable();
            hideLoading("âœ… è³‡æ–™åŒæ­¥å®Œæˆ");
        } catch (e) {
            console.error(e);
            hideLoading();
            alert("âŒ è®€å–å¤±æ•—\n\nåŸå› ï¼š" + e.message + "\n\nè«‹ç¢ºèªï¼š\n1. ç¶²å€æ˜¯å¦æ­£ç¢ºï¼Ÿ\n2. Google Sheet æ˜¯å¦å·²ã€Œç™¼å¸ƒåˆ°ç¶²è·¯ã€ï¼Ÿ\n3. ç™¼å¸ƒæ¬Šé™æ˜¯å¦ç‚ºã€Œå…¬é–‹ã€(éåƒ…é™å…¬å¸)ï¼Ÿ");
        }
    }

    async function saveRow(id, silent = false) {
        const rowData = getRowData(id);
        issuesData[id] = rowData;
        if (!silent) renderTable();
        if (!silent) showLoading("â˜ï¸ ä¸Šå‚³ä¸­...");
        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(rowData)
            });
            if (!silent) hideLoading("âœ… é›²ç«¯å„²å­˜æˆåŠŸï¼");
        } catch (err) { hideLoading(); alert("ä¸Šå‚³å¤±æ•—ï¼š" + err); }
    }

    async function handleBatchUpload(input) {
        if (!input.files.length) return;
        const file = input.files[0];
        if (!confirm(`ç¢ºå®šè¦ä¸Šå‚³ ${file.name} åˆ°é›²ç«¯å—ï¼Ÿ\nåœ–ç‰‡æœƒè‡ªå‹•ä¸Šå‚³åˆ°é›²ç«¯ç¡¬ç¢Ÿã€‚`)) { input.value = ''; return; }
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const json = JSON.parse(e.target.result);
                const sourceData = json.issues || json; 
                const items = Object.values(sourceData);
                showLoading(`æº–å‚™ä¸Šå‚³ ${items.length} ç­†è³‡æ–™...`);
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    item.action = 'update';
                    if(!item.status) item.status = 'saved';
                    if(item.imgs) item.imgs = convertOldImgs(item.imgs);
                    if(item.replyImgs) item.replyImgs = convertOldImgs(item.replyImgs);
                    showLoading(`ä¸Šå‚³ç¬¬ ${i+1} / ${items.length} ç­†... (ID: ${item.id})`);
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST', mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(item)
                    });
                    await new Promise(r => setTimeout(r, 1000));
                }
                hideLoading("âœ… å…¨éƒ¨ä¸Šå‚³å®Œæˆï¼åœ–ç‰‡å·²è½‰å­˜ Driveã€‚");
                alert("ä¸Šå‚³å®Œæˆï¼è«‹ç­‰å¾… 5 åˆ†é˜å¾Œå†æŒ‰ã€ŒğŸ“¥ è®€å–é›²ç«¯ã€ã€‚");
            } catch (err) { hideLoading(); alert("è§£æ JSON å¤±æ•—ï¼š" + err); }
        };
        reader.readAsText(file);
    }
    function convertOldImgs(list) {
        if (!Array.isArray(list)) return [];
        return list.map(img => { if (typeof img === 'string') return { name: 'image.jpg', data: img }; return img; });
    }

    async function handleFile(input, id, field) {
        const files = Array.from(input.files);
        if(files.length + (issuesData[id][field]||[]).length > 5) {
            alert("å–®ä¸€æ¬„ä½æœ€å¤š 5 å€‹é™„ä»¶"); input.value = ''; return;
        }
        if (!issuesData[id][field]) issuesData[id][field] = [];
        showLoading("æ­£åœ¨å£“ç¸®åœ–ç‰‡...");
        for (let f of files) {
            try {
                if (f.type.startsWith('image/')) {
                    const compressedData = await compressImage(f);
                    issuesData[id][field].push({ name: f.name, data: compressedData });
                } else {
                    const data = await new Promise(r => {
                        const rd = new FileReader();
                        rd.onload = (e) => r(e.target.result);
                        rd.readAsDataURL(f);
                    });
                    issuesData[id][field].push({ name: f.name, data: data });
                }
            } catch (e) { console.error("åœ–ç‰‡è™•ç†å¤±æ•—", e); alert("åœ–ç‰‡è™•ç†å¤±æ•—: " + f.name); }
        }
        hideLoading();
        renderTable();
    }
    function compressImage(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 1024; const MAX_HEIGHT = 1024;
                    let width = img.width; let height = img.height;
                    if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } } else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.onerror = reject;
            };
            reader.onerror = reject;
        });
    }

    function getRowData(id) {
        return {
            id: parseInt(id),
            status: issuesData[id].status === 'new' ? 'saved' : issuesData[id].status,
            date: document.getElementById(`date-${id}`).value,
            workOrder: document.getElementById(`wo-${id}`).value,
            model: document.getElementById(`model-${id}`).value,
            batchQty: document.getElementById(`qty-${id}`).value,
            failQty: document.getElementById(`fail-${id}`).value,
            failRate: document.getElementById(`rate-${id}`).value,
            category: document.getElementById(`cat-${id}`).value,
            issue: document.getElementById(`issue-${id}`).value,
            peOwner: document.getElementById(`pe-${id}`).value,
            replyContent: document.getElementById(`reply-${id}`).value,
            completionDate: document.getElementById(`compDate-${id}`).value,
            imgs: issuesData[id].imgs || [],
            replyImgs: issuesData[id].replyImgs || [],
            action: 'update'
        };
    }

    async function deleteRow(id) {
        if (!confirm("ç¢ºå®šåˆªé™¤æ­¤é …ç›®ï¼Ÿ\nâš ï¸ é€™æœƒåŒæ­¥åˆªé™¤é›²ç«¯è³‡æ–™ï¼Œç„¡æ³•å¾©åŸï¼")) return;
        showLoading("â˜ï¸ æ­£åœ¨åˆªé™¤...");
        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id, action: 'delete' })
            });
            delete issuesData[id];
            renderTable();
            hideLoading("ğŸ—‘ï¸ å·²åˆªé™¤");
        } catch (err) { hideLoading(); alert("åˆªé™¤å¤±æ•—"); }
    }

    // --- æ–°ç‰ˆ ID ç”Ÿæˆé‚è¼¯ï¼šYYMMxxxx ---
    function addNewRow() {
        const now = new Date();
        const yy = String(now.getFullYear()).slice(-2);
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        // åŸºç¤å‰ç¶´ï¼š26120000
        const basePrefix = parseInt(yy + mm) * 10000; 
        
        // æ‰¾å‡ºæ‰€æœ‰ç¬¦åˆæ­¤æœˆä»½é–‹é ­çš„ ID
        const currentIds = Object.keys(issuesData).map(Number);
        const monthlyIds = currentIds.filter(id => id > basePrefix && id < basePrefix + 9999);
        
        let nextId;
        if (monthlyIds.length > 0) {
            nextId = Math.max(...monthlyIds) + 1;
        } else {
            nextId = basePrefix + 1; // è©²æœˆç¬¬ä¸€ç­†ï¼š26120001
        }
        
        // é˜²æ­¢é‡è¤‡ (é˜²å‘†)
        while (issuesData[nextId]) { nextId++; }

        issuesData[nextId] = {
            id: nextId,
            status: 'new',
            date: now.toISOString().split('T')[0],
            imgs: [],
            replyImgs: []
        };
        
        renderTable();
        // è‡ªå‹•æ²å‹•ä¸¦èšç„¦
        setTimeout(() => {
            const input = document.getElementById(`wo-${nextId}`);
            if(input) {
                input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                input.focus();
            }
        }, 100);
    }

    function csvToJSON(csvText) {
        const rows = [];
        let row = [];
        let current = "";
        let inQuote = false;
        
        for (let i = 0; i < csvText.length; i++) {
            const char = csvText[i];
            const nextChar = csvText[i+1];
            if (inQuote) {
                if (char === '"' && nextChar === '"') { current += '"'; i++; } else if (char === '"') { inQuote = false; } else { current += char; }
            } else {
                if (char === '"') { inQuote = true; } else if (char === ',') { row.push(current); current = ""; } else if (char === '\r' || char === '\n') {
                    if (char === '\r' && nextChar === '\n') i++; row.push(current); if(row.length > 1) rows.push(row); row = []; current = "";
                } else { current += char; }
            }
        }
        if (current || row.length > 0) { row.push(current); if(row.length > 1) rows.push(row); }

        const result = {};
        for (let i = 1; i < rows.length; i++) {
            const r = rows[i];
            const id = parseInt(r[0]);
            if (isNaN(id)) continue;
            result[id] = {
                id: id, status: r[1]||'new', date: r[2]||'', workOrder: r[3]||'', model: r[4]||'',
                batchQty: r[5]||'', failQty: r[6]||'', failRate: r[7]||'', category: r[8]||'',
                issue: r[9]||'', peOwner: r[10]||'', replyContent: r[11]||'', completionDate: r[12]||'',
                imgs: safeJsonParse(r[13]), replyImgs: safeJsonParse(r[14])
            };
        }
        return result;
    }
    function safeJsonParse(str) { try { return JSON.parse(str); } catch (e) { return []; } }
    
    function loadSettings() {
        peList = JSON.parse(localStorage.getItem('peList')) || ["æœªæŒ‡å®š", "Ray", "Lin", "PE Team"];
        catList = JSON.parse(localStorage.getItem('catList')) || ["å…¶ä»–", "BOMå•é¡Œ", "ç¼ºä»¶", "çµ„è£ç•°å¸¸", "ä¾†æ–™ä¸è‰¯"];
        colorSettings = JSON.parse(localStorage.getItem('colorSettings')) || [{label:'æ­£å¸¸',days:0,color:'#ffffff'},{label:'è­¦ç¤º',days:3,color:'#fff9c4'}, {label:'åš´é‡',days:7,color:'#fee2e2'}];
    }
    function saveSettingsLocal() { localStorage.setItem('peList', JSON.stringify(peList)); localStorage.setItem('catList', JSON.stringify(catList)); localStorage.setItem('colorSettings', JSON.stringify(colorSettings)); }
    
    // æ¸²æŸ“è¡¨æ ¼ (æ–°å¢è² è²¬äººéæ¿¾ + å¾…è¾¦é‚è¼¯)
    function renderTable() {
        const tbody = document.querySelector('#issueTable tbody');
        const sStatus = document.getElementById('statusFilter').value;
        const sPe = document.getElementById('peFilter').value; // æ–°å¢è² è²¬äººéæ¿¾
        const sCat = document.getElementById('categoryFilter').value;
        const sQuery = document.getElementById('searchInput').value.toLowerCase();
        const sField = document.getElementById('searchField').value;
        tbody.innerHTML = '';
        const ids = Object.keys(issuesData).sort((a,b)=>b-a);
        if (ids.length === 0) { document.getElementById('empty-msg').style.display = 'block'; return; } else { document.getElementById('empty-msg').style.display = 'none'; }
        ids.forEach(id => {
            const d = issuesData[id];
            
            // è² è²¬äººéæ¿¾
            if (sPe !== 'all' && d.peOwner !== sPe) return;

            // ç‹€æ…‹éæ¿¾ (å«å¾…è¾¦é‚è¼¯)
            if (sStatus === 'active') {
                if (d.status === 'closed') return;
            } else if (sStatus === 'closed') {
                if (d.status !== 'closed') return;
            }

            if (sCat !== 'all' && d.category !== sCat) return;
            if (sQuery && !(d[sField] || "").toString().toLowerCase().includes(sQuery)) return;
            const st = d.status || 'new';
            const tr = document.createElement('tr');
            tr.style.cssText = getRowStyle(d.date, st);
            
            const makeFileHtml = (files, field) => (files || []).map((f, i) => {
                const isData = f.data && f.data.toString().startsWith('data:');
                const isUrl = f.data && f.data.toString().startsWith('http');
                const isImg = isData ? f.data.startsWith('data:image/') : (isUrl ? true : false);
                const src = f.data;
                const ext = f.name ? f.name.split('.').pop().toLowerCase() : ''; 
                
                let iconHtml = ICONS.fileGen;
                if(ext === 'pdf') iconHtml = ICONS.filePdf;
                else if(['doc','docx'].includes(ext)) iconHtml = ICONS.fileDoc;
                else if(['xls','xlsx','csv'].includes(ext)) iconHtml = ICONS.fileXls;

                let finalSrc = src;
                if (src.includes("drive.google.com") && src.includes("id=")) {
                    const idMatch = src.match(/id=([^&]+)/);
                    if (idMatch) {
                        finalSrc = `https://drive.google.com/thumbnail?id=${idMatch[1]}&sz=w4000`;
                    }
                }

                return `<div class="img-wrapper">
                    ${isImg ? `<img src="${finalSrc}" class="img-thumb" onclick="openLightbox('${finalSrc}')" title="${f.name}" referrerpolicy="no-referrer" onerror="this.onerror=null;this.parentElement.innerHTML='<div class=\\'broken-img-box\\'><span>åœ–ç‰‡<br>ç„¡æ³•è®€å–</span></div>';">` : `<a href="${src}" target="_blank" class="file-icon-link" title="${f.name}">${iconHtml}</a>`}
                    ${st!=='closed' ? `<div class="img-del" onclick="confirmRemoveImg(${id},'${field}',${i})">Ã—</div>` : ''}
                </div>`;
            }).join('');
            
            const peOptions = peList.map(p => `<option value="${p}" ${d.peOwner===p?'selected':''}>${p}</option>`).join('');
            const catOptions = catList.map(c => `<option value="${c}" ${d.category===c?'selected':''}>${c}</option>`).join('');
            tr.innerHTML = `<td style="text-align:center"><input type="checkbox" class="row-select" data-id="${id}"></td><td style="text-align:center"><strong>#${id}</strong><span class="badge badge-${st==='closed'?'closed':'tracking'}">${st==='closed'?'å·²çµæ¡ˆ':'å¾…è™•ç†'}</span></td><td><input type="date" id="date-${id}" value="${d.date || ''}" ${st==='closed'?'disabled':''}></td><td><input type="text" id="wo-${id}" value="${d.workOrder || ''}" placeholder="å·¥å–®" ${st==='closed'?'disabled':''}><input type="text" id="model-${id}" value="${d.model || ''}" placeholder="æ©Ÿç¨®" style="margin-top:2px" ${st==='closed'?'disabled':''}></td><td><input type="number" id="qty-${id}" value="${d.batchQty || ''}" oninput="calcR(${id})" ${st==='closed'?'disabled':''} placeholder="æ‰¹"><input type="number" id="fail-${id}" value="${d.failQty || ''}" oninput="calcR(${id})" style="margin-top:2px" ${st==='closed'?'disabled':''} placeholder="ä¸"><input type="text" id="rate-${id}" value="${d.failRate || '0%'}" readonly style="margin-top:2px; background:#f1f5f9; border:none;"></td><td><div class="thumb-container">${makeFileHtml(d.imgs, 'imgs')}</div>${st!=='closed'?`<input type="file" multiple style="font-size:9px;width:100%" onchange="handleFile(this,${id},'imgs')">`:''}</td><td style="position:relative"><span class="zoom-icon" onclick="openDetailView(${id}, 'issue')">${ICONS.zoom}</span><select id="cat-${id}" style="margin-bottom:4px" ${st==='closed'?'disabled':''}>${catOptions}</select><textarea id="issue-${id}" rows="2" ${st==='closed'?'disabled':''}>${d.issue || ''}</textarea></td><td><select id="pe-${id}" ${st==='closed'?'disabled':''}>${peOptions}</select></td><td style="position:relative"><span class="zoom-icon" onclick="openDetailView(${id}, 'reply')">${ICONS.zoom}</span><textarea id="reply-${id}" rows="4" ${st==='closed'?'disabled':''}>${d.replyContent || ''}</textarea></td><td><div class="thumb-container">${makeFileHtml(d.replyImgs, 'replyImgs')}</div>${st!=='closed'?`<input type="file" multiple style="font-size:9px;width:100%" onchange="handleFile(this,${id},'replyImgs')">`:''}</td><td><input type="date" id="compDate-${id}" value="${d.completionDate || ''}" ${st==='closed'?'disabled':''}></td><td style="text-align:center">${st !== 'closed' ? `<button class="btn btn-save btn-op" onclick="saveRow(${id})">${ICONS.save} å„²å­˜</button><button class="btn btn-close btn-op" onclick="closeRow(${id})">${ICONS.close} çµæ¡ˆ</button><button class="btn btn-del btn-op" onclick="deleteRow(${id})">${ICONS.trash} åˆªé™¤</button>` : `<button class="btn btn-edit btn-op" onclick="reopenRow(${id})">${ICONS.edit} ä¿®æ”¹</button>`}</td>`;
            tbody.appendChild(tr);
        });
    }
    
    function getRowStyle(dateStr, status) { if (status === 'closed' || !dateStr) return ''; const diff = Math.floor((new Date() - new Date(dateStr)) / (1000 * 60 * 60 * 24)); let activeRule = null; colorSettings.forEach(rule => { if (diff >= rule.days) { if (!activeRule || rule.days > activeRule.days) activeRule = rule; } }); return activeRule ? `background-color:${activeRule.color}` : ''; }
    async function closeRow(id) { if (confirm("ç¢ºèªçµæ¡ˆï¼Ÿ\né€™å°‡é–å®šå…§å®¹ä¸¦åŒæ­¥è‡³é›²ç«¯ã€‚")) { issuesData[id].status = 'closed'; await saveRow(id); } }
    async function reopenRow(id) { if (confirm("é‡æ–°é–‹å•Ÿæ­¤æ¡ˆä»¶ï¼Ÿ")) { issuesData[id].status = 'saved'; await saveRow(id); } }
    function calcR(id) { const q = parseFloat(document.getElementById(`qty-${id}`).value) || 0; const f = parseFloat(document.getElementById(`fail-${id}`).value) || 0; document.getElementById(`rate-${id}`).value = q > 0 ? ((f / q) * 100).toFixed(2) + '%' : '0%'; }
    
    function confirmRemoveImg(id, field, index) { if(confirm("ç¢ºå®šç§»é™¤æ­¤é™„ä»¶ï¼Ÿ")) { issuesData[id][field].splice(index, 1); renderTable(); } }
    function showLoading(msg = "è™•ç†ä¸­...") { const t = document.getElementById("toast"); document.getElementById("toast-msg").innerText = msg; document.getElementById("toast-loader").style.display = "block"; t.className = "loading"; }
    function hideLoading(msg) { const t = document.getElementById("toast"); t.className = ""; document.getElementById("toast-loader").style.display = "none"; if (msg) showToast(msg); }
    function showToast(m) { const t = document.getElementById("toast"); document.getElementById("toast-msg").innerText = m; document.getElementById("toast-loader").style.display = "none"; t.className = "show"; setTimeout(() => t.className = "", 3000); }
    function openLightbox(s) { document.getElementById("lightbox-img").src = s; document.getElementById("lightbox").style.display = "flex"; }
    
    // æ›´æ–°è¨­å®šè¦–çª—é‚è¼¯
    function openSettingModal() { document.getElementById('settingModal').style.display = 'block'; updateSetUI(); renderColorSet(); }
    function closeSettingModal() { saveSettingsLocal(); document.getElementById('settingModal').style.display = 'none'; updateFilters(); renderTable(); }
    
    function updateSetUI() { document.getElementById('peListContainer').innerHTML = peList.map((p,i) => `<li>${p} <span onclick="peList.splice(${i},1);updateSetUI()" style="color:red;cursor:pointer;float:right">Ã—</span></li>`).join(''); document.getElementById('catListContainer').innerHTML = catList.map((c,i) => `<li>${c} <span onclick="catList.splice(${i},1);updateSetUI()" style="color:red;cursor:pointer;float:right">Ã—</span></li>`).join(''); }
    function addSettingItem(t) { const inp = document.getElementById(t === 'pe' ? 'newPeName' : 'newCatName'); if (inp.value) { (t === 'pe' ? peList : catList).push(inp.value); inp.value = ''; updateSetUI(); } }
    function renderColorSet() { document.getElementById('colorSettingsList').innerHTML = colorSettings.map((s,i) => `<div style="display:flex;gap:5px;margin-bottom:5px"><input type="text" value="${s.label}" onchange="colorSettings[${i}].label=this.value" style="flex:2"><input type="number" value="${s.days}" onchange="colorSettings[${i}].days=parseInt(this.value)" style="flex:1"><input type="color" value="${s.color}" onchange="colorSettings[${i}].color=this.value" style="width:30px"></div>`).join(''); }
    function addColorSetting() { colorSettings.push({label:'æ–°è¦å‰‡', days:1, color:'#ffffff'}); renderColorSet(); }
    function openExportModal() { document.getElementById('exportModal').style.display = 'flex'; }
    function executeExport() { const statusLimit = document.getElementById('exportStatusSelect').value; const data = [["ID", "ç‹€æ…‹", "æ—¥æœŸ", "å·¥å–®", "æ©Ÿç¨®", "æ‰¹é‡", "ä¸è‰¯æ•¸", "ä¸è‰¯ç‡", "é¡åˆ¥", "æè¿°", "è² è²¬äºº", "å›è¦†", "å®Œæˆæ—¥"]]; Object.values(issuesData).sort((a,b)=>b.id-a.id).forEach(i => { if(statusLimit !== 'all' && i.status !== statusLimit) return; data.push([i.id, i.status, i.date, i.workOrder, i.model, i.batchQty, i.failQty, i.failRate, i.category, i.issue, i.peOwner, i.replyContent, i.completionDate]); }); const ws = XLSX.utils.aoa_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "List"); XLSX.writeFile(wb, `Report_${new Date().toISOString().slice(0,10)}.xlsx`); document.getElementById('exportModal').style.display = 'none'; showToast("ğŸ“Š Excel å·²åŒ¯å‡º"); }
    function sendMail() { const selectedIds = Array.from(document.querySelectorAll('.row-select:checked')).map(cb => cb.dataset.id); if (!selectedIds.length) return alert("è«‹å‹¾é¸è¦å¯„å‡ºçš„é …ç›®"); let h = `<table border="1" style="border-collapse:collapse; width:100%; font-size:13px;"><tr style="background:#f1f5f9;"><th>ID</th><th>æ—¥æœŸ</th><th>å·¥å–®</th><th>æ©Ÿç¨®</th><th>ä¸è‰¯æ•¸(ç‡)</th><th>å•é¡Œæè¿°</th><th>è² è²¬äºº</th><th>æ”¹å–„å›è¦†</th></tr>`; selectedIds.forEach(id => { const d = issuesData[id]; h += `<tr><td style="text-align:center">#${id}</td><td>${d.date}</td><td>${d.workOrder}</td><td>${d.model}</td><td style="text-align:center">${d.failQty}(${d.failRate})</td><td>${d.issue}</td><td style="text-align:center">${d.peOwner}</td><td>${d.replyContent}</td></tr>`; }); h += `</table>`; const blob = new Blob([h], { type: 'text/html' }); navigator.clipboard.write([new ClipboardItem({ 'text/html': blob })]).then(() => { showToast("ğŸ“‹ å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Œè«‹è²¼ä¸Šéƒµä»¶"); window.location.href = "mailto:?subject=ç•°å¸¸è¿½è¹¤åŒ¯å ±"; }); }
    function openDetailView(id, type) { 
        const d = issuesData[id]; 
        const modal = document.getElementById('detailModal'); 
        const imgBox = document.getElementById('detailImgs'); 
        const files = type === 'issue' ? (d.imgs || []) : (d.replyImgs || []); 
        document.getElementById('detailTitle').innerText = type === 'issue' ? `#${id} å•é¡Œæè¿°` : `#${id} æ”¹å–„å›è¦†`; 
        document.getElementById('detailText').innerText = document.getElementById(`${type==='issue'?'issue':'reply'}-${id}`).value; 
        imgBox.innerHTML = ''; 
        files.forEach(f => { 
            const isData = f.data && f.data.toString().startsWith('data:');
            const isUrl = f.data && f.data.toString().startsWith('http');
            const isImg = isData ? f.data.startsWith('data:image/') : (isUrl ? true : false);
            const src = f.data;
            const ext = f.name ? f.name.split('.').pop().toLowerCase() : ''; 
            const icon = ext==='pdf'?'ğŸ“•':(['doc','docx'].includes(ext)?'ğŸ“˜':(['xls','xlsx','csv'].includes(ext)?'ğŸ“—':'ğŸ“„')); 
            imgBox.innerHTML += `<div class="large-thumb-box">${isImg ? `<img src="${src}" class="large-thumb-img" onclick="openLightbox('${src}')">` : `<a href="${src}" target="_blank" style="text-decoration:none; font-size:40px;">${icon}<div style="font-size:12px; color:#333;">${f.name}</div></a>`}</div>`; 
        }); 
        modal.style.display = 'block'; 
    }
    function closeDetailModal() { document.getElementById('detailModal').style.display='none'; }
    function toggleSelectAll(m) { document.querySelectorAll('.row-select').forEach(cb => cb.checked = m.checked); }
    
    // æ›´æ–°æ‰€æœ‰ç¯©é¸å™¨çš„ä¸‹æ‹‰é¸å–®
    function updateFilters() { 
        // æ›´æ–°é¡åˆ¥
        const fCat = document.getElementById('categoryFilter'); 
        const currentCat = fCat.value;
        fCat.innerHTML='<option value="all">é¡åˆ¥(å…¨)</option>' + catList.map(c=>`<option value="${c}">${c}</option>`).join(''); 
        fCat.value = currentCat; // ä¿æŒé¸æ“‡

        // æ›´æ–°è² è²¬äºº (æ–°å¢)
        const fPe = document.getElementById('peFilter');
        const currentPe = fPe.value;
        fPe.innerHTML = '<option value="all">è² è²¬äºº(å…¨)</option>' + peList.map(p => `<option value="${p}">${p}</option>`).join('');
        fPe.value = currentPe;
    }
</script>
</body>
</html>